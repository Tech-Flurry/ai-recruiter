@using Dointo.AiRecruiter.Core.States
@using Dointo.AiRecruiter.Dtos
@using System.ComponentModel.DataAnnotations
@using Dointo.AiRecruiter.InterviewClient.Utils
@inject IHttpClientFactory HttpClientFactory

<h3>Create Candidate</h3>
@if (!string.IsNullOrEmpty(statusMessage))
{
  <div class="alert @statusAlertClass">@statusMessage</div>
}
<EditForm Model="@candidate" OnValidSubmit="HandleValidSubmit">
  <DataAnnotationsValidator />
  <ValidationSummary />

  <div class="form-group">
    <label>First Name</label>
    <InputText @bind-Value="candidate.FirstName" class="form-control" />
    <ValidationMessage For="@(() => candidate.FirstName)" />
  </div>

  <div class="form-group">
    <label>Last Name</label>
    <InputText @bind-Value="candidate.LastName" class="form-control" />
    <ValidationMessage For="@(() => candidate.LastName)" />
  </div>

  <div class="form-group">
    <label>Date of Birth</label>
    <InputDate @bind-Value="candidate.DateOfBirth" class="form-control" />
    <ValidationMessage For="@(() => candidate.DateOfBirth)" />
  </div>

  <div class="form-group">
    <label>Email</label>
    <InputText @bind-Value="candidate.Email" class="form-control" type="email" />
    <ValidationMessage For="@(() => candidate.Email)" />
  </div>

  <div class="form-group">
    <label>Phone</label>
    <InputText @bind-Value="candidate.Phone" class="form-control" />
    <ValidationMessage For="@(() => candidate.Phone)" />
  </div>

  <div class="form-group">
    <label>Job Title</label>
    <InputText @bind-Value="candidate.JobTitle" class="form-control" />
    <ValidationMessage For="@(() => candidate.JobTitle)" />
  </div>

  <div class="form-group">
    <label>Location</label>
    <InputText @bind-Value="candidate.Location" class="form-control" />
    <ValidationMessage For="@(() => candidate.Location)" />
  </div>

  <!-- Education, Certifications, Experiences, and Skills can be implemented as sub-forms or lists -->
  <div class="form-group my-2">
    <label>Education History</label>
    <button type="button" class="btn btn-secondary btn-sm mb-2" @onclick="AddEducation"><i class="bi bi-plus"></i></button>
    @foreach (var edu in candidate.EducationHistory)
    {
      <div class="mb-2">
        <div class="row align-items-center">
          <div class="col-md-4">
            <InputText @bind-Value="edu.Certificate" class="form-control" placeholder="Degree" />
          </div>
          <div class="col-md-4">
            <InputText @bind-Value="edu.Institution" class="form-control" placeholder="Name of Institution" />
          </div>
          <div class="col-md-3">
            <InputDate @bind-Value="edu.YearOfCompletion" class="form-control" placeholder="Completion Date" />
          </div>
          <div class="col-md-1 text-end">
            <button type="button" class="btn btn-outline-danger btn-sm" @onclick="() => RemoveEducation(edu)">
              <i class="bi bi-trash"></i>
            </button>
          </div>
        </div>
      </div>
    }
  </div>

  <div class="form-group my-2">
    <label>Certifications</label>
    <button type="button" class="btn btn-secondary btn-sm mb-2" @onclick="AddCertification"><i class="bi bi-plus"></i></button>
    @foreach (var cert in candidate.Certifications)
    {
      <div class="mb-2">
        <div class="row align-items-center">
          <div class="col-md-4">
            <InputText @bind-Value="cert.Certificate" class="form-control" placeholder="Certificate" />
          </div>
          <div class="col-md-4">
            <InputText @bind-Value="cert.Institution" class="form-control" placeholder="Institution" />
          </div>
          <div class="col-md-3">
            <InputDate @bind-Value="cert.YearOfCompletion" class="form-control" placeholder="Year of Completion" />
          </div>
          <div class="col-md-1 text-end">
            <button type="button" class="btn btn-outline-danger btn-sm" @onclick="() => RemoveCertification(cert)">
              <i class="bi bi-trash"></i>
            </button>
          </div>
        </div>
      </div>
    }
  </div>

  <div class="form-group my-2">
    <label>Experiences</label>
    <button type="button" class="btn btn-secondary btn-sm mb-2" @onclick="AddExperience"><i class="bi bi-plus"></i></button>
    @foreach (var exp in candidate.Experiences)
    {
      <div class="mb-2">
        <div class="row align-items-center">
          <div class="col-md-3">
            <InputText @bind-Value="exp.JobTitle" class="form-control" placeholder="Job Title" />
          </div>
          <div class="col-md-3">
            <InputText @bind-Value="exp.Company" class="form-control" placeholder="Company" />
          </div>
          <div class="col-md-3">
            <InputText @bind-Value="exp.Details" class="form-control" placeholder="Details" />
          </div>
          <div class="col-md-1">
            <InputDate @bind-Value="exp.StartDate" class="form-control" placeholder="Start Date" />
          </div>
          <div class="col-md-1">
            <InputDate @bind-Value="exp.EndDate" class="form-control" placeholder="End Date (optional)" />
          </div>
          <div class="col-md-1 text-end">
            <button type="button" class="btn btn-outline-danger btn-sm" @onclick="() => RemoveExperience(exp)">
              <i class="bi bi-trash"></i>
            </button>
          </div>
        </div>
      </div>
    }
  </div>

  <div class="form-group my-2">
    <label>Skills</label>
    <button type="button" class="btn btn-secondary btn-sm mb-2" @onclick="AddSkill"><i class="bi bi-plus"></i></button>
    @foreach (var skill in candidate.SKills)
    {
      <div class="mb-2">
        <div class="row align-items-center">
          <div class="col-md-8">
            <InputText @bind-Value="skill.Skill" class="form-control" placeholder="Skill" />
          </div>
          <div class="col-md-3">
            <select @bind="skill.Rating" class="form-control">
              <option value="1">1</option>
              <option value="2">2</option>
              <option value="3">3</option>
              <option value="4">4</option>
              <option value="5">5</option>
            </select>
          </div>
          <div class="col-md-1 text-end">
            <button type="button" class="btn btn-outline-danger btn-sm" @onclick="() => RemoveSkill(skill)">
              <i class="bi bi-trash"></i>
            </button>
          </div>
        </div>
      </div>
    }
  </div>

  <button type="submit" class="btn btn-primary" disabled="@isProcessing">
    @if (isProcessing)
    {
      <span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>
      <text>Submitting...</text>
    }
    else
    {
      <text>Submit</text>
    }
  </button>
</EditForm>

@code {
  private CreateCandidateDto candidate = new();
  private HttpClient httpClient = null!;
  private string statusMessage = string.Empty;
  private string statusAlertClass = "alert-info";
  private bool isProcessing = false;

  protected override void OnInitialized()
  {
    base.OnInitialized();
    httpClient = HttpClientFactory.CreateClient(Constants.API_CLIENT_NAME);
  }

  private async void HandleValidSubmit()
  {
    statusMessage = string.Empty;
    statusAlertClass = "alert-info";
    isProcessing = true;
    StateHasChanged();
    try
    {
      candidate.Id = string.Empty;
      var response = await httpClient.PostAsJsonAsync("api/interviews/create-candidate", candidate);

      if (response.IsSuccessStatusCode)
      {
        var processingState = await response.Content.ReadFromJsonAsync<IProcessingState>(new System.Text.Json.JsonSerializerOptions
        {
          PropertyNameCaseInsensitive = true,
          Converters = { new ProcessingStateJsonConverter() }
        });

        if (processingState is SuccessState success)
        {
          statusMessage = success.Message;
          statusAlertClass = "alert-success";
          candidate = new();
        }
        else if (processingState is ValidationErrorState validation)
        {
          statusMessage = validation.Message + string.Join("<br/>", validation.Errors.Select(e => $"{e.PropertyName}: {e.ErrorMessage}"));
          statusAlertClass = "alert-warning";
        }
        else if (processingState is ExceptionState exception)
        {
          statusMessage = exception.Message + (string.IsNullOrWhiteSpace(exception.ExceptionMessage) ? "" : $"<br/>{exception.ExceptionMessage}");
          statusAlertClass = "alert-danger";
        }
        else
        {
          statusMessage = "Unknown response from server.";
          statusAlertClass = "alert-danger";
        }
      }
      else
      {
        statusMessage = $"Server error: {response.ReasonPhrase}";
        statusAlertClass = "alert-danger";
      }
    }
    catch (Exception ex)
    {
      statusMessage = $"An error occurred: {ex.Message}";
      statusAlertClass = "alert-danger";
    }
    finally
    {
      isProcessing = false;
      StateHasChanged();
    }
  }

  private void AddEducation()
  {
    candidate.EducationHistory.Add(new CredentialDto());
  }

  private void AddCertification()
  {
    candidate.Certifications.Add(new CredentialDto());
  }

  private void AddExperience()
  {
    candidate.Experiences.Add(new ExperienceDto());
  }

  private void AddSkill()
  {
    candidate.SKills.Add(new SkillRatingDto { Rating = 5 });
  }

  private void RemoveEducation(CredentialDto edu)
  {
    candidate.EducationHistory.Remove(edu);
  }

  private void RemoveCertification(CredentialDto cert)
  {
    candidate.Certifications.Remove(cert);
  }

  private void RemoveExperience(ExperienceDto exp)
  {
    candidate.Experiences.Remove(exp);
  }

  private void RemoveSkill(SkillRatingDto skill)
  {
    candidate.SKills.Remove(skill);
  }
}
